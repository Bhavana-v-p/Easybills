<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EasyBills - Expense Reimbursement Portal</title>
  <!-- Load Tailwind CSS for modern, responsive styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #667eea; /* Indigo */
      --secondary: #764ba2; /* Purple */
      --text-dark: #222;
      --text-light: #fff;
    }
    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    }
    .login-logo {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    .feature-list li {
      margin: 0.8rem 0;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }
    .feature-list li::before {
      content: "✓";
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    /* Hide the default HTML form fields */
    .login-right .traditional-login {
        display: none !important;
    }
    /* Simple utility classes for dynamic display */
    .hidden-js { display: none; }
  </style>
</head>
<body>

  <!-- Main App Container -->
  <div id="app-container" class="w-full h-full">

    <!-- --------------------------------------- -->
    <!-- 1. LOGIN PAGE (Initial View) -->
    <!-- --------------------------------------- -->
    <section id="login-page" class="w-full h-full flex items-center justify-center p-4">
      <div class="login-container bg-white rounded-3xl shadow-2xl overflow-hidden flex w-full max-w-5xl min-h-[550px]">
        
        <!-- Left side: Branding & Features -->
        <div class="login-left flex-1 bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-8 sm:p-12 hidden md:flex flex-col justify-center items-center text-center">
          <div class="login-logo w-24 h-24 rounded-full flex items-center justify-center text-4xl font-extrabold mb-4">₹</div>
          <h2 class="text-3xl font-bold mb-2">EasyBills</h2>
          <p class="text-base opacity-90 mb-6">Track Every Rupee, Digitally and Transparently.</p>
          <ul class="feature-list list-none text-left font-medium text-sm">
            <li>Digital bill uploads & secure storage (FR03)</li>
            <li>Real-time claim status tracking (FR05)</li>
            <li>Role-based dashboards for teams (FR07)</li>
            <li>Full audit trail & compliance (FR06)</li>
          </ul>
        </div>
        
        <!-- Right side: Authentication -->
        <div class="login-right flex-1 p-8 sm:p-12 flex flex-col justify-center">
          <div class="login-form-header mb-8">
            <h1 class="text-3xl text-gray-900 font-extrabold mb-2">Faculty Sign-In</h1>
            <p class="text-gray-600 text-base">Secure access required to continue to the portal.</p>
          </div>
          
          <!-- Security Restriction -->
          <div class="mb-6 p-3 bg-red-100 border border-red-300 rounded-xl text-red-700 font-semibold text-sm text-center">
            Access is strictly restricted to official BITS Email IDs.
          </div>

          <!-- Traditional Login (Hidden as per Project Scope) -->
          <form class="traditional-login">
            <!-- Email and Password fields are retained from original HTML but hidden -->
            <div class="form-group mb-4">
                <label for="email" class="block text-gray-800 font-medium mb-1">Email Address</label>
                <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" placeholder="you@example.com">
            </div>
             <button type="submit" class="w-full p-3 bg-gray-400 text-white font-semibold rounded-xl cursor-not-allowed">Sign In (Disabled)</button>
          </form>

          <!-- Divider -->
          <div class="flex items-center my-6">
            <hr class="flex-grow border-t border-gray-200">
            <span class="px-3 text-gray-500 font-medium text-sm">SECURE LOGIN</span>
            <hr class="flex-grow border-t border-gray-200">
          </div>
          
          <!-- Google Login Button (Primary Action) -->
          <button id="googleLoginBtn" class="google-login-btn w-full p-3 bg-white border-2 border-indigo-500 text-gray-800 font-bold rounded-xl shadow-md hover:bg-indigo-50 transition duration-150 flex items-center justify-center" onclick="handleGoogleLogin()">
            <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M44.5 20h-2.5v4h-4v2h4v4h2.5v-4h4v-2h-4v-4z" fill="#4285F4"/>
              <path d="M24 10c3.5 0 6.5 1.4 8.7 3.6l3.6-3.6C33.1 5.9 28.7 4 24 4c-8.9 0-16.1 6.5-17.5 15.1l4.4 3.4C13.2 16.5 18 10 24 10z" fill="#EA4335"/>
              <path d="M4.1 24c0-1.5.2-2.9.5-4.3l4.4 3.4v1.8l-4.4 3.4c-.3-1.3-.5-2.7-.5-4.3z" fill="#FBBC05"/>
              <path d="M24 44c6.3 0 11.6-2.6 15.5-6.6l-4.8-3.7c-2 2.4-4.8 3.9-8.7 3.9-5.8 0-10.7-3.9-12.4-9.2H4.1C5.5 37.5 13.2 44 24 44z" fill="#34A853"/>
            </svg>
            Continue with BITS Google ID
          </button>
        </div>
      </div>
    </section>

    <!-- --------------------------------------- -->
    <!-- 2. HOME PAGE / DASHBOARD (Private View) -->
    <!-- --------------------------------------- -->
    <section id="home-page" class="hidden-js w-full min-h-screen bg-gray-50">
      
      <!-- Header -->
      <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
          <h1 class="text-2xl font-bold text-gray-900 flex items-center">
             <svg class="w-6 h-6 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
             EasyBills
          </h1>
          <div class="flex items-center space-x-4">
            <span id="welcomeMessage" class="text-sm font-medium text-gray-600 hidden sm:inline">Welcome, User (Faculty)</span>
            <button onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl shadow-md transition duration-150">
              Logout
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto py-10 sm:px-6 lg:px-8">
        <div class="p-8 rounded-xl shadow-2xl bg-white border border-gray-100">
          <h2 id="dashboardTitle" class="text-3xl font-extrabold text-gray-900 mb-2">Faculty Claim Portal</h2>
          <p id="dashboardSubtitle" class="text-xl text-indigo-600 mb-8">Your central hub for expense submission and tracking.</p>

          <div id="optionsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Dynamic Cards will be rendered here by JavaScript -->
          </div>
          
          <div class="mt-10 pt-6 border-t border-gray-100">
             <p class="text-sm text-gray-500 text-center italic">
                The EasyBills system ensures a full digital audit trail for every transaction (FR06).
             </p>
          </div>
        </div>
      </main>
    </section>

  </div>

  <script>
    // --- Configuration ---
    // **CRITICAL CHANGE:** Use your secure production API domain here.
    const BACKEND_URL = window.location.protocol === 'https:' 
        ? 'https://api.easybills.bits.ac.in' // Production API URL
        : 'http://localhost:3000'; // Fallback for local testing
        
    const LOGIN_PAGE = document.getElementById('login-page');
    const HOME_PAGE = document.getElementById('home-page');
    const TOKEN_KEY = 'easybills_token';

    // --- State and Utility Functions ---
    let isAuthenticated = false;
    let currentUser = null;

    function getPayload(token) {
        try {
            return JSON.parse(atob(token.split('.')[1]));
        } catch (e) {
            return null;
        }
    }

    function isTokenValid(token) {
        if (!token) return false;
        const payload = getPayload(token);
        if (!payload || !payload.exp) return false;
        // Check if token expires in the future
        return payload.exp * 1000 > Date.now() - 60000;
    }

    function updateAuthState(token) {
        if (token && isTokenValid(token)) {
            localStorage.setItem(TOKEN_KEY, token);
            isAuthenticated = true;
            const payload = getPayload(token);
            // Simulate user data from token
            currentUser = { 
                name: 'Pravin Pawar', // Mock Name
                role: payload.role || 'Faculty', 
                id: payload.id 
            };
        } else {
            localStorage.removeItem(TOKEN_KEY);
            isAuthenticated = false;
            currentUser = null;
        }
    }

    // --- Dynamic Content Rendering ---

    const facultyOptions = [
        { title: 'Submit New Claim', description: 'Digitally submit a new reimbursement request with attached receipts. (FR02, FR03)', iconColor: 'text-indigo-600', colorClass: 'border-indigo-300/50 hover:border-indigo-500/50 hover:bg-indigo-50', action: () => alert('Action: Navigating to Claim Submission Form (FR02, FR03)...') },
        { title: 'Track Claim Status', description: 'View the real-time status and digital Audit Trail of all claims. (FR05, FR06)', iconColor: 'text-green-600', colorClass: 'border-green-300/50 hover:border-green-500/50 hover:bg-green-50', action: () => alert('Action: Navigating to Claims Tracking List (FR05, FR06)...') },
        { title: 'Notifications & Alerts', description: 'Check for clarification requests (FR10) or immediate status changes.', iconColor: 'text-amber-600', colorClass: 'border-amber-300/50 hover:border-amber-500/50 hover:bg-amber-50', action: () => alert('Action: Navigating to Notifications/Alerts (FR10)...') },
        { title: 'View/Download Archives', description: 'Access and download past settled claims and their original documents. (FR11)', iconColor: 'text-sky-600', colorClass: 'border-sky-300/50 hover:border-sky-500/50 hover:bg-sky-50', action: () => alert('Action: Navigating to Archives (FR11)...') },
    ];

    const accountsOptions = [
        { title: 'Verification Dashboard', description: 'Review and verify pending claims submitted by faculty. (FR07)', iconColor: 'text-indigo-600', colorClass: 'border-indigo-300/50 hover:border-indigo-500/50 hover:bg-indigo-50', action: () => alert('Action: Navigating to Claims Verification Dashboard (FR07)...') },
        { title: 'Process Approvals', description: 'Approve claims and update the final payment status. (FR08)', iconColor: 'text-green-600', colorClass: 'border-green-300/50 hover:border-green-500/50 hover:bg-green-50', action: () => alert('Action: Navigating to Approval Queue (FR08)...') },
        { title: 'Add Comment/Clarification', description: 'Send feedback or clarification requests to faculty (FR09).', iconColor: 'text-amber-600', colorClass: 'border-amber-300/50 hover:border-amber-500/50 hover:bg-amber-50', action: () => alert('Action: Navigating to Comment Submission (FR09)...') },
        { title: 'System Audit Logs', description: 'Access the global audit log for administrative compliance (FR06).', iconColor: 'text-sky-600', colorClass: 'border-sky-300/50 hover:border-sky-500/50 hover:bg-sky-50', action: () => alert('Action: Navigating to System Audit Logs...') }
    ];

    function getIconSVG(title) {
        const icons = {
            'Submit New Claim': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242M12 18v3M9 21h6"/></svg>', // Upload
            'Track Claim Status': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>', // Clock
            'Notifications & Alerts': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>', // Bell
            'View/Download Archives': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="10" y2="9"/></svg>', // FileText
            'Verification Dashboard': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>', // UserCheck
            'Process Approvals': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>', // CheckCircle
            'Add Comment/Clarification': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>', // MessageCircle
            'System Audit Logs': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8.3L15 12l-3.7-3.7-5 5"/></svg>' // BarChart
        };
        return icons[title] || '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 8v4l2 2"/></svg>'; // Default Icon
    }

    function renderHomePage() {
        const options = currentUser.role === 'Accounts' ? accountsOptions : facultyOptions;
        const roleText = currentUser.role === 'Accounts' ? 'Accounts Verification Dashboard' : 'Faculty Claim Portal';
        const subtitle = currentUser.role === 'Accounts' ? 'Review outstanding claims to simplify verification and payment.' : 'Your central hub for expense submission and tracking.';

        document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.name} (${currentUser.role})`;
        document.getElementById('dashboardTitle').textContent = roleText;
        document.getElementById('dashboardSubtitle').textContent = subtitle;

        const grid = document.getElementById('optionsGrid');
        grid.innerHTML = ''; // Clear previous options

        options.forEach(option => {
            const button = document.createElement('button');
            button.className = `flex flex-col items-start p-6 rounded-xl border-2 border-transparent transition duration-300 transform hover:scale-[1.02] hover:shadow-xl shadow-md bg-white text-left w-full ${option.colorClass}`;
            button.onclick = option.action;
            
            button.innerHTML = `
                <div class="w-8 h-8 mb-3 ${option.iconColor}">${getIconSVG(option.title)}</div>
                <h3 class="text-lg font-semibold text-gray-800 mb-1">${option.title}</h3>
                <p class="text-sm text-gray-500 mb-4">${option.description}</p>
                <div class="flex items-center text-sm font-medium text-indigo-600 mt-auto">
                    Go to section <svg class="w-4 h-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                </div>
            `;
            grid.appendChild(button);
        });

        LOGIN_PAGE.classList.add('hidden-js');
        HOME_PAGE.classList.remove('hidden-js');
    }

    // --- Authentication Handlers ---

    function handleGoogleLogin() {
        // Redirect to the Node.js backend's OAuth initiation endpoint
        window.location.href = BACKEND_URL + '/api/auth/google';
    }

    function handleLogout() {
        // Clear local storage and redirect to server logout endpoint
        localStorage.removeItem(TOKEN_KEY);
        // This redirect clears the server session and then redirects back to the frontend
        window.location.href = BACKEND_URL + '/api/auth/logout';
    }

    function init() {
        // 1. Check for JWT token in URL (after successful callback from backend)
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token) {
            updateAuthState(token);
            // Clean up the URL to prevent token reuse
            window.history.replaceState({}, document.title, window.location.pathname);
        } else {
            // 2. Check for existing token in localStorage
            const storedToken = localStorage.getItem(TOKEN_KEY);
            updateAuthState(storedToken);
        }

        // 3. Render the correct page
        if (isAuthenticated) {
            renderHomePage();
        } else {
            LOGIN_PAGE.classList.remove('hidden-js');
            HOME_PAGE.classList.add('hidden-js');
        }
    }

    // Run initialization on page load
    window.onload = init;
  </script>
</body>
</html>
